generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["spk"]
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  name      String
  password  String
  role      Role
  mitra_id  Int?
  createdAt DateTime @default(now())
  mitra     Mitra?   @relation(fields: [mitra_id], references: [id])

  @@map("user")
  @@schema("spk")
}

model Mitra {
  id          Int            @id @default(autoincrement())
  nama_mitra  String
  nik         String?
  email       String?
  alamat      String?
  no_hp       String?
  bank        String?
  no_rekening String?
  created_at  DateTime       @default(now())
  alokasi     AlokasiMitra[]
  spk         SpkDocument[]
  users       User[]

  @@map("mitra")
  @@schema("spk")
}

model MataAnggaran {
  id            Int        @id @default(autoincrement())
  kode_anggaran String
  nama_anggaran String
  tahun         Int
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  kegiatan      Kegiatan[]

  @@unique([kode_anggaran, tahun])
  @@map("mata_anggaran")
  @@schema("spk")
}

model Kegiatan {
  id               Int            @id @default(autoincrement())
  kode_kegiatan    String?
  nama_kegiatan    String
  satuan           String?
  mata_anggaran_id Int
  created_at       DateTime       @default(now())
  jenis_kegiatan   String
  tahun            Int
  tarif_per_satuan Int?
  alokasi          AlokasiMitra[]
  mataAnggaran     MataAnggaran   @relation(fields: [mata_anggaran_id], references: [id])

  @@unique([nama_kegiatan, tahun], map: "kegiatan_nama_tahun_unique")
  @@index([jenis_kegiatan], map: "idx_kegiatan_jenis")
  @@index([tahun], map: "idx_kegiatan_tahun")
  @@map("kegiatan")
  @@schema("spk")
}

model AlokasiMitra {
  id          Int      @id @default(autoincrement())
  tahun       Int
  bulan       Int
  mitra_id    Int
  kegiatan_id Int
  volume      Decimal
  tarif       Decimal
  jumlah      Decimal
  status      String   @default("DRAFT")
  created_at  DateTime @default(now())
  kegiatan    Kegiatan @relation(fields: [kegiatan_id], references: [id])
  mitra       Mitra    @relation(fields: [mitra_id], references: [id])

  @@map("alokasi_mitra")
  @@schema("spk")
}

model SpkRole {
  id           Int           @id @default(autoincrement())
  kode_role    String        @unique
  nama_role    String
  aktif        Boolean       @default(true)
  created_at   DateTime      @default(now())
  spkDocuments SpkDocument[]

  @@map("spk_role")
  @@schema("spk")
}

model SpkDocument {
  id               Int       @id @default(autoincrement())
  tahun            Int
  bulan            Int
  mitra_id         Int
  total_honorarium Decimal
  nomor_spk        String
  created_at       DateTime  @default(now())
  spk_kegiatan     String
  spk_role         String
  spk_role_id      Int
  tanggal_mulai    DateTime
  tanggal_selesai  DateTime
  kegiatan_ids     Int[]
  admin_note       String?
  approved_at      DateTime?
  approved_by      String?
  status           SpkStatus @default(PENDING)
  mitra            Mitra     @relation(fields: [mitra_id], references: [id])
  spkRole          SpkRole   @relation(fields: [spk_role_id], references: [id])

  @@map("spk_document")
  @@schema("spk")
}

model VBastRincian {
  tahun         Int
  bulan         Int
  nama_mitra    String
  nama_kegiatan String
  kode_anggaran String
  volume        Decimal
  tarif         Decimal
  jumlah        Decimal

  @@map("v_bast_rincian")
  @@ignore
  @@schema("spk")
}

enum Role {
  ADMIN
  MITRA

  @@schema("spk")
}

enum SpkStatus {
  PENDING
  APPROVED
  REJECTED

  @@schema("spk")
}
