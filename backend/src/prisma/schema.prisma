generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["spk"]
}

model User {
  id           String        @id @default(uuid())
  username     String        @unique
  name         String
  password     String
  role         Role
  mitra_id     Int?
  createdAt    DateTime      @default(now())
  email        String?       @unique(map: "user_email_unique")
  spkDocuments SpkDocument[]
  spkRequests  SpkRequest[]
  mitra        Mitra?        @relation(fields: [mitra_id], references: [id])

  @@map("user")
  @@schema("spk")
}

model Mitra {
  id             Int              @id @default(autoincrement())
  nama_mitra     String
  nik            String?
  email          String?
  alamat         String?
  no_hp          String?
  bank           String?
  no_rekening    String?
  created_at     DateTime         @default(now())
  alokasi        AlokasiMitra[]
  penilaianMitra PenilaianMitra[]
  spkDocuments   SpkDocument[]
  users          User[]

  @@map("mitra")
  @@schema("spk")
}

model MataAnggaran {
  id            Int               @id @default(autoincrement())
  kode_anggaran String
  nama_anggaran String
  tahun         Int
  is_active     Boolean           @default(true)
  created_at    DateTime          @default(now())
  kegiatan      Kegiatan[]
  spkItems      SpkDocumentItem[]

  @@unique([kode_anggaran, tahun])
  @@map("mata_anggaran")
  @@schema("spk")
}

model Kegiatan {
  id               Int               @id @default(autoincrement())
  kode_kegiatan    String?
  nama_kegiatan    String
  satuan           String?
  mata_anggaran_id Int
  created_at       DateTime          @default(now())
  jenis_kegiatan   String
  tahun            Int
  tarif_per_satuan Int?
  mataAnggaran     MataAnggaran      @relation(fields: [mata_anggaran_id], references: [id])
  spkItems         SpkDocumentItem[]
  requestItems     SpkRequestItem[]

  @@unique([nama_kegiatan, tahun], map: "kegiatan_nama_tahun_unique")
  @@index([jenis_kegiatan], map: "idx_kegiatan_jenis")
  @@index([tahun], map: "idx_kegiatan_tahun")
  @@map("kegiatan")
  @@schema("spk")
}

model SpkRole {
  id           Int           @id @default(autoincrement())
  kode_role    String        @unique
  nama_role    String
  aktif        Boolean       @default(true)
  created_at   DateTime      @default(now())
  spkDocuments SpkDocument[]

  @@map("spk_role")
  @@schema("spk")
}

model SpkDocument {
  id                   Int               @id @default(autoincrement())
  tahun                Int
  bulan                Int
  mitra_id             Int
  total_honorarium     Decimal
  nomor_spk            String
  created_at           DateTime          @default(now())
  spk_kegiatan         String
  spk_role             String
  spk_role_id          Int
  tanggal_mulai        DateTime          @db.Date
  tanggal_selesai      DateTime          @db.Date
  admin_note           String?
  approved_at          DateTime?
  approved_by          String?
  status               SpkStatus         @default(PENDING)
  tanggal_pembayaran   String?
  tanggal_perjanjian   String?
  created_by_user_id   String
  created_by_user_name String?
  alokasi              AlokasiMitra?
  penilaianMitra       PenilaianMitra[]
  user                 User              @relation(fields: [created_by_user_id], references: [id], map: "fk_spk_created_by")
  mitra                Mitra             @relation(fields: [mitra_id], references: [id], map: "fk_spk_document_mitra")
  spkRole              SpkRole           @relation(fields: [spk_role_id], references: [id], map: "fk_spk_document_role")
  items                SpkDocumentItem[]
  requests             SpkRequest[]

  @@unique([mitra_id, bulan, tahun], map: "uniq_spk_mitra_bulan_tahun")
  @@index([mitra_id, bulan, tahun], map: "idx_spk_mitra_bulan_tahun")
  @@index([status], map: "idx_spk_status")
  @@index([created_by_user_id], map: "spk_document_created_by_idx")
  @@index([created_by_user_id, status], map: "spk_document_created_by_status_idx")
  @@map("spk_document")
  @@schema("spk")
}

model SpkDocumentItem {
  id               Int          @id @default(autoincrement())
  spk_document_id  Int
  kegiatan_id      Int
  mata_anggaran_id Int
  jangka_waktu     String
  volume           Decimal
  harga_satuan     Decimal
  nilai            Decimal
  kegiatan         Kegiatan     @relation(fields: [kegiatan_id], references: [id], map: "fk_spk_item_kegiatan")
  mataAnggaran     MataAnggaran @relation(fields: [mata_anggaran_id], references: [id], map: "fk_spk_item_mata_anggaran")
  spkDocument      SpkDocument  @relation(fields: [spk_document_id], references: [id], onDelete: Cascade, map: "fk_spk_item_spk")

  @@unique([spk_document_id, kegiatan_id], map: "uniq_spk_kegiatan")
  @@index([spk_document_id])
  @@index([kegiatan_id])
  @@index([mata_anggaran_id])
  @@map("spk_document_item")
  @@schema("spk")
}

model SpkRequest {
  id                 Int              @id @default(autoincrement())
  spk_document_id    Int
  created_by_user_id String
  status             String           @default("PENDING")
  admin_note         String?
  created_at         DateTime         @default(now())
  approved_at        DateTime?
  approved_by        String?
  spkDocument        SpkDocument      @relation(fields: [spk_document_id], references: [id], onDelete: Cascade, map: "fk_request_spk")
  user               User             @relation(fields: [created_by_user_id], references: [id], map: "fk_request_user")
  items              SpkRequestItem[]

  @@index([created_by_user_id], map: "spk_request_user_idx")
  @@map("spk_request")
  @@schema("spk")
}

model SpkRequestItem {
  id             Int        @id @default(autoincrement())
  spk_request_id Int
  kegiatan_id    Int
  volume         Decimal
  harga_satuan   Decimal
  nilai          Decimal
  status         String     @default("PENDING")
  admin_note     String?
  kegiatan       Kegiatan   @relation(fields: [kegiatan_id], references: [id], map: "fk_request_item_kegiatan")
  spkRequest     SpkRequest @relation(fields: [spk_request_id], references: [id], onDelete: Cascade, map: "fk_request_item_request")

  @@index([spk_request_id], map: "spk_request_item_request_idx")
  @@map("spk_request_item")
  @@schema("spk")
}

model AlokasiMitra {
  id              Int         @id @default(autoincrement())
  tahun           Int
  bulan           Int
  mitra_id        Int
  status          String      @default("APPROVED")
  created_at      DateTime    @default(now())
  spk_document_id Int         @unique
  total_nilai     Decimal
  nomor_urut      Int?
  nomor_spk       String?     @unique(map: "alokasi_mitra_nomor_spk_unique")
  mitra           Mitra       @relation(fields: [mitra_id], references: [id])
  spkDocument     SpkDocument @relation(fields: [spk_document_id], references: [id])

  @@unique([nomor_urut, tahun], map: "alokasi_mitra_nomor_urut_tahun_unique")
  @@unique([tahun, nomor_urut], map: "uniq_alokasi_nomor_urut_tahun")
  @@index([tahun], map: "idx_alokasi_tahun")
  @@map("alokasi_mitra")
  @@schema("spk")
}

model PenilaianMitra {
  id              Int               @id @default(autoincrement())
  spk_document_id Int
  mitra_id        Int
  ketepatan_waktu Int
  kualitas        Int
  komunikasi      Int
  created_at      DateTime?         @default(now()) @db.Timestamp(6)
  details         PenilaianDetail[]
  mitra           Mitra             @relation(fields: [mitra_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_penilaian_mitra")
  spkDocument     SpkDocument       @relation(fields: [spk_document_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_penilaian_spk")

  @@unique([spk_document_id, mitra_id], map: "uniq_penilaian")
  @@index([mitra_id], map: "idx_penilaian_mitra_mitra")
  @@index([spk_document_id], map: "idx_penilaian_mitra_spk")
  @@map("penilaian_mitra")
  @@schema("spk")
}

model SawCriterion {
  id               Int               @id @default(autoincrement())
  name             String            @db.VarChar(100)
  key              String            @unique @db.VarChar(100)
  weight           Float
  type             String            @db.VarChar(20)
  is_active        Boolean?          @default(true)
  created_at       DateTime?         @default(now()) @db.Timestamp(6)
  penilaianDetails PenilaianDetail[]

  @@map("saw_criterion")
  @@schema("spk")
}

model PenilaianDetail {
  id           Int            @id @default(autoincrement())
  penilaian_id Int
  criterion_id Int
  value        Float
  criterion    SawCriterion   @relation(fields: [criterion_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  penilaian    PenilaianMitra @relation(fields: [penilaian_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([penilaian_id, criterion_id])
  @@index([criterion_id], map: "idx_penilaian_detail_criterion")
  @@index([penilaian_id], map: "idx_penilaian_detail_penilaian")
  @@map("penilaian_detail")
  @@schema("spk")
}

model AlokasiMitraDetail {
  id               Int      @id @default(autoincrement())
  alokasi_mitra_id Int
  spk_document_id  Int
  mitra_id         Int
  kegiatan_id      Int
  mata_anggaran_id Int
  nilai            Decimal
  created_at       DateTime @default(now())

  @@index([kegiatan_id])
  @@index([mata_anggaran_id])
  @@index([spk_document_id])
  @@map("alokasi_mitra_detail")
  @@schema("spk")
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model temp_excel_data {
  Nama             String?
  Kegiatan         String?
  Honor            String?
  Honor_Per_Satuan String? @map("Honor Per Satuan")
  Volume           String?
  Mata_Anggaran    String? @map("Mata Anggaran")
  Tanggal_Mulai    String? @map("Tanggal Mulai")
  Tanggal_Berakhir String? @map("Tanggal Berakhir")

  @@ignore
  @@schema("spk")
}

enum Role {
  ADMIN
  MITRA
  KETUA_TIM

  @@schema("spk")
}

enum SpkStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED

  @@schema("spk")
}
